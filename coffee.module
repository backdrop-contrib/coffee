<?php

/**
 * @file
 * Coffee primary module file
 *
 * Implements hook_perm, hook_menu, hook_init
 * and a function to handle the result for Coffee.
 */

/**
 * Implements hook_permission().
 */
function coffee_permission() {
  return array(
    'access coffee' => array(
      'title' => t('Access Coffee'),
      'description' => t('Access the Coffee search box to navigate fast between admin pages'),
  ),
  );
}

/**
 * Implements hook_menu().
 */
function coffee_menu() {

  // define menu callback for ajax calls to handle the results
  $items['admin/coffee/result/%'] = array(
    'title' => 'Coffee Result Handler',
    'page callback' => 'coffee_result_handler',
    'page arguments' => array(3),
    'access arguments' => array('access coffee'),
    'type' => MENU_CALLBACK,
  );
  return $items;

}

/**
 * Handler for Coffee
 *
 * The coffee_result_hanlder will process the input,
 * look for matches and returns a json encoded result that is used
 * in the javascript to display the results.
 *
 * @param
 *    string $input is used to build the query
 * @return
 *    json encoded output with results based on the $input
 */
function coffee_result_handler($input = FALSE) {

  // based on the first char coffee should handle a function callback
  // or the basic functionality (redirecting to paths)
  $action_trigger = ':';

  // if the $action_trigger is fired
  // invoke all implementations of hook_coffee_action()
  if (strstr(check_plain(urldecode($input)), $action_trigger)) {
    // execute action, invode hook_coffee
    foreach (module_implements('coffee_action') as $module) {
      $op = str_ireplace($action_trigger, '', $input);
      $result = module_invoke($module, 'coffee_action', $op);
    }
  }
  else {
    // is should fire the default implementation of Coffee
    // it invokes the coffee_redirect function to look in the menu_links table
    $result = coffee_redirect($input);
  }

  if (!empty($result)) {
    // return should be in json format so the JavaScript can handle it
    print json_encode($result);
  }
  drupal_exit();

}

/**
 * Implements hook_init().
 * Users with the permission 'access coffee' can fire up Coffee
 */
function coffee_init() {
  // only users with the permission access coffee can use coffee
  if (user_access('access coffee')) {
    // add the javascript and css files
    drupal_add_js(drupal_get_path('module', 'coffee') . '/coffee.js', array('type' => 'file'));
    drupal_add_css(drupal_get_path('module', 'coffee') . '/coffee.css', array('type' => 'file'));

    // include the default hooks for coffee
    module_load_include('inc', 'coffee', 'coffee.hooks');
  }

}

/**
 * Implements hook_help().
 */
function coffee_help($path, $arg) {
  switch ($path) {
    case 'admin/help#coffee':

      $output = '
      <h3>About</h3>
      <p>
       Coffee is a module used for rapidly navigation between the Drupal
       administration pages. This module is inspired by Alfred /
       Spotlight for OSX.
      </p>

      <h3>Uses</h3>
      <p>
       <dl>
        <dt>Open Coffee<dt>
         <dd>Press alt + d to fire up Coffee - an input box will show up</dd>
         <dt>Search</dt>
         <dd>Type the title or path of the page you want to visit</dt>
				 <dt>Navigating in the result list</dt>
         <dd>Navigate with Arrow Down / Arrow Up in the resultlist to select the page you want to visit</dd>
         <dt>Visit result</dt>
         <dd>Hit Enter to visit the selected result</dd>
         <dt>Close Coffee</dt>
         <dd>Close Coffee with Esc or Alt + d</dd>
       </dl>
      </p>
      ';

  return $output;
  }
}
